---
title: "Работа с категориальными данными"
date: "`r format(Sys.Date(), '%Y.%m.%d')`"
---

```{r setup, include=FALSE}
source("../style.R")
```

# Пример исходных данных

В 2009 в Свазиленде (Южная Африка) был рекорд по зараженности ВИЧ. Процент зараженных среди населения составил 25.9%. Для тестирования зараженности использовали тест ELISA.

Рассмотрим для примера выборку из 50 человек, иллюстрирующую ситуацию.

```{r}
library(tidyverse)
library(magrittr)
# true positives - 12.9
TP = data.frame(true_diagnosis = rep("HIV", 12),
               elisa_results = rep("HIV", 12))
# true negatives - 34.3
TN = data.frame(true_diagnosis = rep("healthy", 34),
               elisa_results = rep("healthy", 34))

# false positves - 2.74
FP = data.frame(true_diagnosis = rep("healthy", 3),
               elisa_results = rep("HIV", 3))

# false negatives - 0.0388
FN = data.frame(true_diagnosis = rep("HIV", 1),
               elisa_results = rep("healthy", 1))

d = list(TP, TN, FP, FN) %>% reduce(rbind) %>% sample_n(., nrow(.)) %>% set_rownames(1:nrow(.))

d %>% table()

d %>% table %>% addmargins()

# посчитаем долю зараженных от общего числа
13/50

# посчитаем долю здоровых от общего числа
37/50

# посчитаем долю правильно диагностированных среди тех, кто заражен
12/13

# посчитаем долю правильно диагностированных среди тех, кто здоров
34/37
```

Вопрос: если человек получили диагноз "болен", то какая вероятность, что он действительно болен?

Поскольку диагноз известен, мы можем отбросить известную информацию о тех, кто был диагностирован как здоров. Поэтому смотрим на первый столбец. 12 человек из 15 были диагностированы правильно, т.е. вероятность $P(true=HIV|ELISA=HIV) = 12/15 = 0.80$. Это условная вероятность, какова вероятность одного, если известна вероятность другого.

В общем виде для вычисления таких вероятностей используется теорема Байеса:

$$
P(A|B) = \frac{P(A \cap B)}{P(B)} = \frac{12}{12+3}=0.80
$$

На самом деле, цифры немного другие. Для этого теста точность предсказания для тех, кто заражен, составляет 99.7%. А для тех, кто здоров - 92.6%.

Другими словами, зараженному с вероятностью 1-0.997 скажут, что он здоров (ложно-отрицательный диагноз, ошибка II рода), а здоровому с вероятностью 1-0.926 скажут, что он болен (ложно-положительный диагноз, ошибка I рода).

Вопрос: отражают ли результаты ELISA зараженность? Можно ли по ним судить о зараженности или они не дают никакой полезной информации?

Ответ на вопрос может дать 

* $\chi^2$ -критерий Пирсона
* Точный критерий Фишера (для маленьких выборок незаменим)
* Логистическая регрессия

```{r}
d %>% table() %>% chisq.test()

d %>% table() %>% fisher.test()

d %>% glm(true_diagnosis ~ elisa_results, data = ., family = binomial(link = "logit")) %>% confint

```